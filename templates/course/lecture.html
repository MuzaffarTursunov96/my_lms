{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<style>
    .sidebar {
      max-height: 80vh;
      overflow-y: auto;
    }
    .video-container {
      position: relative;
      padding-top: 56.25%;
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
    .tab-content {
      padding-top: 1rem;
    }

    .sidebar h5 {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1c1d1f;
    }

    .accordion-item {
      border-radius: 0.5rem;
      margin-bottom: 0.75rem;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      border: none;
    }

    .accordion-button {
      font-weight: 600;
      background-color: #f8f9fa;
    }

    .accordion-button:not(.collapsed) {
      color: #0c0d0e;
      background-color: #e9ecef;
    }

    .list-group-item {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .list-group-item:hover {
      background-color: #f1f3f5;
    }

    .text-size{
      font-size:24px;
    }
    .span-text-size{
      font-size:14px
    }
  </style>
<div class="container-fluid">
  <div class="row">
    <!-- Left content -->
    <div class="col-lg-8 col-md-12 p-3">
      <h5>{{course.title}}</h5>

      <div class="video-container mb-3" style="position: relative;">
        <iframe 
          id="vimeo-player"
          src="https://player.vimeo.com/video/76979871" 
          allow="autoplay; fullscreen; picture-in-picture" 
          >
        </iframe>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="courseTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="qa-tab" data-bs-toggle="tab" data-bs-target="#qa" type="button" role="tab">Q&A</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">Notes</button>
        </li>
      </ul>
      <div class="tab-content" id="courseTabsContent">
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
          <p>Full Practice Exam with Explanations included! PASS the Amazon Web Services Developer Certification.</p>
        </div>
        <div class="tab-pane fade" id="qa" role="tabpanel">
          <p>Q&A Section will go here.</p>
        </div>
        <div class="tab-pane fade" id="notes" role="tabpanel">
          <p>Your notes will be shown here.</p>
        </div>
      </div>
    </div>

    <!-- Right sidebar -->
    <div class="col-lg-4 col-md-12 p-3">
      <h4>{% trans 'Course Sections'%}</h4>
      <div class="sidebar" >
        <div class="accordion" id="courseAccordion">
        {% for section in sections %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
              <button class="accordion-button collapsed text-size" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse{{ forloop.counter }}">
                <span>{{ forloop.counter }}. {{ section.title }}</span>
              </button>
              <span class="section-progress text-muted small ms-2 span-text-size">
                {{ section.lectures.count}}/{{ section.lectures.count }} | {{section.formatted_total_duration}} 
              </span>
            </h2>
            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#courseAccordion">
              <div class="accordion-body">
                <ul class="list-group list-group-flush">
                  {% for item in section.items %}
                    {% if item.content_object %}
                      {% if item.content_type.model == 'lecture' %}
                        <li class="list-group-item" onclick="my_function(this)" >
                          <a src="{{ item.content_object.video_url }}" class="title-link" type="button" >
                            {{ item.content_object.title }}
                          </a> <br>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-play" viewBox="0 0 16 16">
                            <path d="M6 6.883v4.234a.5.5 0 0 0 .757.429l3.528-2.117a.5.5 0 0 0 0-.858L6.757 6.454a.5.5 0 0 0-.757.43z"/>
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                          </svg> ({{ item.content_object.formatted_duration }})
                        </li>
                      {% elif item.content_type.model == 'quiz' %}
                        <li class="list-group-item">
                          <a href="{%url 'quiz' 1 %}" class="title-link">
                            {% trans 'Quiz'%}: {{ item.content_object.title }}
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-medical" viewBox="0 0 16 16">
                            <path d="M7.5 5.5a.5.5 0 0 0-1 0v.634l-.549-.317a.5.5 0 1 0-.5.866L6 7l-.549.317a.5.5 0 1 0 .5.866l.549-.317V8.5a.5.5 0 1 0 1 0v-.634l.549.317a.5.5 0 1 0 .5-.866L8 7l.549-.317a.5.5 0 1 0-.5-.866l-.549.317zm-2 4.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z"/>
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                          </svg>
                          </a>
                        </li>
                      {% else %}
                        <li class="list-group-item text-muted">
                          {% trans 'Unknown item type'%}: {{ item.content_type.model }}
                        </li>
                      {% endif %}
                    {% else %}
                      <li class="list-group-item text-danger">
                        {% trans 'Content not found for item order'%} {{ item.order }}
                      </li>
                    {% endif %}
                  {% empty %}
                    <li class="list-group-item text-muted">{% trans 'No items in this section.'%}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      </div>
    </div>
  </div>
</div>
<script>
  

  function my_function(element) {
    
    const link = element.querySelector('a').getAttribute('src');
    
    // Update the iframe source
    const iframe_v = document.getElementById('vimeo-player');
    iframe_v.src = link;

  }
  const iframe = document.getElementById('vimeo-player');
  const player = new Vimeo.Player(iframe);

  let watchedSeconds = 0;
  let videoDuration = 0;

  player.getDuration().then(function(duration) {
    videoDuration = duration;
  });

  player.on('timeupdate', function(data) {
    watchedSeconds = data.seconds;
    const percentWatched = (watchedSeconds / videoDuration) * 100;

    // Save every 5 seconds
    if (Math.floor(watchedSeconds) % 5 === 0) {
      console.log('Progress:', Math.floor(percentWatched) + '%');
      
      // You can send this data to your Django backend
      fetch('/save-progress/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'  // Django's CSRF token
        },
        body: JSON.stringify({
          video_id: 76979871,
          watched_percent: percentWatched
        })
      });
    }
  });

  player.on('ended', function() {
    console.log('Video finished');
    // Save full watched status
    fetch('/save-progress/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        video_id: 76979871,
        watched_percent: 100
      })
    });
  });

  fetch('/get-progress/?video_id=76979871')
    .then(res => res.json())
    .then(data => {
      if (data.progress_seconds) {
        player.setCurrentTime(data.progress_seconds).then(function(seconds) {
          console.log('üîÅ Resumed video at', seconds, 'seconds');
        }).catch(function(error) {
          console.error('‚ö†Ô∏è Error seeking video:', error);
        });
      }
    });
</script>

{%endblock%}
